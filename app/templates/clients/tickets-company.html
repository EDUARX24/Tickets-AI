{% extends "layout.html" %}
{% block title %}Tickets de la Empresa{% endblock %}

{% block customCss %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_cliente_adm/cliente_adm.css') }}">
{% endblock %}

{% block content %}
<!-- mostrar los tickets de la empresa aquí -->
<div class="row g-3 mb-3">
        <div class="col-12">
             <div class="bg-white client-card p-4 mb-2 d-flex flex-wrap justify-content-between align-items-center">
                <div class="mb-3 mb-md-0">
                    <p class="section-title mb-1">Panel de cliente</p>
                    <h3 class="mb-1">Administración de tickets de soporte</h3>
                    <p class="mb-0 text-muted">
                        Empresa: <strong>{{ company_name }}</strong><br>
                        Admin: <strong>{{ admin_name }}</strong>
                    </p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <!-- Botón aún sin funcionalidad real -->
                    <a href="{{ url_for('client_admin.choose_create_ticket') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> Nuevo ticket
                    </a>
                </div>
            </div>
            <div class="bg-white rounded-2 p-4 shadow-sm">
     <!-- Fila de título + búsqueda -->
                <div
                    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                    <h5 class="fw-semibold mb-2 mb-md-0">
                        Tickets de la empresa
                    </h5>
                    <div class="input-group input-group-sm" style="max-width: 260px;">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" id="ticketSearch" class="form-control border-start-0"
                            placeholder="Buscar por ID, título o estado">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle mb-0" id="ticketsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 70px;">ID</th>
                                <th>Título</th>
                                <th style="width: 140px;">Estado</th>
                                <th style="width: 190px;">Fecha creación</th>
                                <th style="width: 110px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if tickets %}
                            {% for t in tickets %}
                            <tr>
                                <!-- ID -->
                                <td class="text-muted small">
                                    {{ t.ticket_id }}
                                </td>

                                <!-- Título -->
                                <td>
                                    <span class="fw-semibold d-block">
                                        {{ t.title or 'Sin título' }}
                                    </span>
                                    {# opcional: una pequeña descripción corta si la tienes #}
                                    {% if t.description %}
                                    <small class="text-muted d-none d-md-inline">
                                        {{ t.description[:80] }}{% if t.description|length > 80 %}…{% endif %}
                                    </small>
                                    {% endif %}
                                </td>

                                <!-- Estado -->
                                <td>
                                    {% set status = t.status or 'N/D' %}
                                    {% set status_label_map = {
                                    'open': 'Abierto',
                                    'in_progress': 'En progreso',
                                    'on_hold': 'En espera',
                                    'resolved': 'Resuelto',
                                    'closed': 'Cerrado',
                                    'cancelled': 'Cancelado'
                                    } %}
                                    {% set status_label = status_label_map.get(status, status) %}

                                    {# Colores según estado #}
                                    {% set status_class_map = {
                                    'open': 'bg-primary-subtle text-primary',
                                    'in_progress': 'bg-info-subtle text-info',
                                    'on_hold': 'bg-warning-subtle text-warning',
                                    'resolved': 'bg-success-subtle text-success',
                                    'closed': 'bg-secondary-subtle text-secondary',
                                    'cancelled': 'bg-danger-subtle text-danger'
                                    } %}
                                    {% set status_class = status_class_map.get(status, 'bg-light text-muted') %}

                                    <span class="badge {{ status_class }} border">
                                        {{ status_label }}
                                    </span>
                                </td>

                                <!-- Fecha creación -->
                                <td>
                                    <small class="text-muted">
                                        {# created_at viene como ISO string: 2025-12-02T04:25:31... #}
                                        {{ t.created_at[:10] if t.created_at else '' }}
                                    </small>
                                </td>

                                <!-- Acciones -->
                                <td>
                                    <a href="{{ url_for('client_admin.view_ticket', ticket_id=t.ticket_id) }}"
                                        class="btn btn-sm btn-outline-primary">
                                        Ver
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">
                                    No hay tickets registrados para esta empresa.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                 <!-- Info de paginación -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <small class="text-muted">
          Mostrando 
          {% if total_tickets > 0 %}
            {{ (page - 1) * per_page + 1 }}
            –
            {{ (page - 1) * per_page + tickets|length }}
            de {{ total_tickets }} tickets
          {% else %}
            0 de 0 tickets
          {% endif %}
        </small>

        <!-- Controles de paginación -->
        <nav aria-label="Paginación de tickets">
          <ul class="pagination pagination-sm mb-0">
            <!-- Anterior -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('client_admin.company_tickets', page=page-1) }}"
                 tabindex="-1">
                Anterior
              </a>
            </li>

            <!-- Números de página (simple: 1..total_pages) -->
            {% for p in range(1, total_pages + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link"
                   href="{{ url_for('client_admin.company_tickets', page=p) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            <!-- Siguiente -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{{ url_for('client_admin.company_tickets', page=page+1) }}">
                Siguiente
              </a>
            </li>
          </ul>
        </nav>
      </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block JS %}
{# Script simple de búsqueda en la tabla #}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("ticketSearch");
        const table = document.getElementById("ticketsTable");
        if (!input || !table) return;

        input.addEventListener("input", function () {
            const filter = this.value.toLowerCase();
            const rows = table.querySelectorAll("tbody tr");

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        });
    });
</script>
{% endblock %}