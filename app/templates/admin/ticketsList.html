{% extends "layout.html" %}
{% block title %}Tickets - SysAdmin{% endblock %}

{% block content %}
<div class="container-fluid pt-4 px-4">

  <!-- Encabezado -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="rounded-3 p-4 shadow-sm"
           style="background: linear-gradient(135deg, #e3f2fd, #f1f8ff);">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <div>
            <h4 class="fw-semibold mb-1 text-primary">
              <i class="bi bi-ticket-perforated me-2"></i> Tickets del sistema
            </h4>
            <p class="text-muted mb-0">
              Listado general de tickets registrados en IT MultiService TX.
            </p>
          </div>
          <div class="mt-3 mt-md-0 text-end">
            <div class="small text-muted">Total de tickets</div>
            <div class="fw-bold fs-5">{{ total_tickets }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de tickets -->
  <div class="row g-3">
    <div class="col-12">
      <div class="bg-white rounded-3 p-4 shadow-sm">

        <!-- Título + búsqueda -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
          <h5 class="fw-semibold mb-2 mb-md-0">Listado de tickets</h5>

          <!-- Buscador real -->
          <form method="get"
                class="input-group input-group-sm"
                style="max-width: 260px;">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              name="q"
              class="form-control border-start-0"
              placeholder="Buscar por título o descripción"
              value="{{ q or '' }}">
          </form>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 70px;">ID</th>
                <th>Título</th>
                <th style="width: 110px;">Estado</th>
                <th style="width: 130px;">Prioridad</th>
                <th style="width: 150px;">Categoría</th>
                <th style="width: 170px;">Compañía</th>
                <th style="width: 190px;">Creado</th>
              </tr>
            </thead>
            <tbody>
              {% if tickets %}
                {% for t in tickets %}
                <tr>
                  <!-- ID -->
                  <td class="text-muted small">
                    {{ t.ticket_id }}
                  </td>

                  <!-- Título -->
                  <td>
                    <span class="fw-semibold d-block text-truncate" style="max-width: 320px;">
                      {{ t.title or 'Sin título' }}
                    </span>
                    <small class="text-muted">
                       <!--Creado por usuario #{{ t.created_by_company_user_id or 'N/D' }}-->
                    </small>
                  </td>

                  <!-- Estado -->
                  <td>
                    {% set status = t.status or 'N/D' %}
                    <span class="badge bg-primary-subtle text-primary border">
                      {{ status }}
                    </span>
                  </td>

                  <!-- Prioridad (nombre, no ID) -->
                  <td>
                    {% set pr = t.priority %}
                    {% if pr %}
                      <span class="badge bg-light text-secondary border">
                        {{ pr.code or ('ID ' ~ pr.priority_id) }}
                      </span>
                    {% else %}
                      <span class="badge bg-light text-muted border">
                        Sin prioridad
                      </span>
                    {% endif %}
                  </td>

                  <!-- Categoría (nombre, no ID) -->
                  <td>
                    {% set cat = t.category %}
                    <span class="small text-muted">
                      {{ cat.name if cat else 'Sin categoría' }}
                    </span>
                  </td>

                  <!-- Compañía (nombre comercial o legal) -->
                  <td>
                    {% set comp = t.company %}
                    <span class="small text-muted">
                      {% if comp %}
                        {{ comp.commercialName or comp.name or ('ID ' ~ comp.company_id) }}
                      {% else %}
                        Sin compañía
                      {% endif %}
                    </span>
                  </td>

                  <!-- Fecha creación -->
                  <td>
                    <small class="text-muted">
                      {{ t.created_at or '' }}
                    </small>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted py-3">
                    No hay tickets registrados en el sistema.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        {# Paginación #}
        {% if total_pages > 1 %}
        <nav aria-label="Paginación de tickets" class="mt-3">
          <ul class="pagination pagination-sm mb-0 justify-content-end">

            <!-- Anterior -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link"
                 href="{% if page > 1 %}{{ url_for('admin.admin_tickets', page=page-1, q=q) }}{% else %}#{% endif %}"
                 tabindex="-1">
                Anterior
              </a>
            </li>

            <!-- Números -->
            {% for p in range(1, total_pages + 1) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link"
                   href="{{ url_for('admin.admin_tickets', page=p, q=q) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            <!-- Siguiente -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link"
                 href="{% if page < total_pages %}{{ url_for('admin.admin_tickets', page=page+1, q=q) }}{% else %}#{% endif %}">
                Siguiente
              </a>
            </li>

          </ul>
        </nav>
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endblock %}
