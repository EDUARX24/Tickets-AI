{% extends "layout.html" %}
{% block title %}Usuarios - SysAdmin{% endblock %}

{% block content %}
<div class="container-fluid pt-4 px-4">

  <!-- Encabezado y métricas -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="rounded-3 p-4 shadow-sm"
           style="background: linear-gradient(135deg, #e3f2fd, #f1f8ff);">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <div>
            <h4 class="fw-semibold mb-1 text-primary">
              <i class="bi bi-people me-2"></i> Usuarios del sistema
            </h4>
            <p class="text-muted mb-0">
              Administración general de las cuentas que tienen acceso a IT MultiService TX.
            </p>
          </div>
          <div class="mt-3 mt-md-0 d-flex gap-3">
            <div class="text-end">
              <div class="small text-muted">Total usuarios</div>
              <div class="fw-bold fs-5">{{ total_users }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="row g-3">
    <div class="col-12">
      <div class="bg-white rounded-3 p-4 shadow-sm">

        <!-- Fila de título + búsqueda -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
          <h5 class="fw-semibold mb-2 mb-md-0">
            Listado de usuarios
          </h5>
          <div class="input-group input-group-sm" style="max-width: 260px;">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input type="text"
                   id="userSearch"
                   class="form-control border-start-0"
                   placeholder="Buscar por usuario, email o rol">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0" id="usersTable">
            <thead class="table-light">
              <tr>
                <th style="width: 60px;">ID</th>
                <th>Usuario</th>
                <th>Email</th>
                <th style="width: 150px;">Rol</th>
                <th style="width: 190px;">Creado</th>
              </tr>
            </thead>
            <tbody>
              {% if users %}
                {% for u in users %}
                <tr>
                  <!-- ID -->
                  <td class="text-muted small">
                    {{ u.username_id }}
                  </td>

                  <!-- Usuario -->
                  <td>
                    <span class="fw-semibold">
                      {{ u.username or 'Sin usuario' }}
                    </span>
                  </td>

                  <!-- Email -->
                  <td>
                    <span class="small text-muted">
                      {{ u.email or 'Sin correo' }}
                    </span>
                  </td>

                  <!-- Rol -->
                  <td>
                    {% set role = u.role or 'N/D' %}
                    {% set role_label = {
                      'sysAdmin': 'SysAdmin',
                      'admin_tech': 'Admin Técnico',
                      'admin_cliente': 'Admin Cliente',
                      'admin_op': 'Operador Cliente'
                    }[role] if role in ['sysAdmin','admin_tech','admin_cliente','admin_op'] else role %}

                    <span class="badge bg-primary-subtle text-primary border">
                      {{ role_label }}
                    </span>
                  </td>

                  <!-- Fecha creación -->
                  <td>
                    <small class="text-muted">
                      {{ u.created_at or '' }}
                    </small>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-3">
                    No hay usuarios registrados en el sistema.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block JS %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('userSearch');
  const table = document.getElementById('usersTable');
  if (!input || !table) return;

  const rows = Array.from(table.querySelectorAll('tbody tr'));

  input.addEventListener('input', function () {
    const term = this.value.trim().toLowerCase();

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      // Muestra la fila si el texto contiene el término buscado
      row.style.display = text.includes(term) ? '' : 'none';
    });
  });
});
</script>
{% endblock %}

